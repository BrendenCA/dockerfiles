version: "3"

networks:
  rclone:
    external: true

services:
  rclone:
    image: rclone/rclone:beta
    container_name: rclone
    networks:
      - rclone
    environment:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
    volumes:
      - type: bind
        source: /mnt
        target: /mnt
        bind:
          propagation: rshared
      - ../data/rclone:/config/rclone
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/fuse
    command:
      - mount
      - ${RCLONE_REMOTE_PATH}
      - ${RCLONE_MOUNT_PATH}
      - --allow-other
      - --umask=000
      - --dir-cache-time=999h
      - --fast-list
      - --use-server-modtime
      - --rc
      - --rc-no-auth
      - --rc-addr=:${RCLONE_RC_PORT}
      - --s3-chunk-size=256M
    healthcheck:
      test: ls ${RCLONE_HEALTHCHECK_PATH} || exit 1
      interval: 1m
      timeout: 15s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  mergerfs:
    image: hotio/mergerfs:release
    container_name: mergerfs
    network_mode: none
    volumes:
      - type: bind
        source: /mnt
        target: /mnt
        bind:
          propagation: rshared
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/fuse
    command:
      - -odefaults,allow_other,umask=000,direct_io,category.create=ff
      - ${MERGERFS_LOCAL_PATH}:${RCLONE_MOUNT_PATH}
      - ${MERGERFS_MOUNT_PATH}
    healthcheck:
      test: ls ${MERGERFS_HEALTHCHECK_PATH} || exit 1
      interval: 1m
      timeout: 15s
      retries: 3
      start_period: 15s
    restart: unless-stopped